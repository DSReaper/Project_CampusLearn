<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title || 'CampusLearn Chatbot' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/chat.css" />
  <link rel="alternate icon" href="/icons/favicon.ico" sizes="any">
</head>
<body>
  <!-- Falling code background -->
  <div class="code-bg" id="codeBg"></div>

  <div class="wrap">
    <div class="card">
      <h1>CampusLearn Chatbot</h1>
      <p class="sub">Ask anything IT-related (errors, concepts, study skills) — or general academic help.</p>

      <div class="chat-box">
        <div id="msgs" class="msgs"></div>

<div class="input-wrap">
  <div class="input-container">
    <input id="inp" class="input" placeholder="Type your message..." />
    <button id="send" class="send-icon" title="Send">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 12h14.5l-4.8-4.8 1.4-1.4L21 12l-6.9 6.2-1.4-1.4 4.8-4.8H3z" />
      </svg>
    </button>
  </div>
</div>

<div class="clear-row">
  <button id="clearChat" class="btn">Clear</button>
</div>

      </div>
    </div>
  </div>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const msgs = document.getElementById("msgs");
  const inp  = document.getElementById("inp");
  const btn  = document.getElementById("send");
  const clearBtn = document.getElementById("clearChat");
  let history = [];

  // --- icons ---
  const ROBOT_SVG = `
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M11 3h2v2h3a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3h3V3zm5 7.5a1.5 1.5 0 1 0-3.001-.001A1.5 1.5 0 0 0 16 10.5zm-7 0A1.5 1.5 0 1 0 6 10.5 1.5 1.5 0 0 0 9 10.5zm-2 5.5h10v1H7v-1z"/>
  </svg>`;
  const HUMAN_SVG = `
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>
  </svg>`;

  // --- one and only add() that injects avatars ---
  function add(role, text) {
    const m = document.createElement("div");
    m.className = "msg " + (role === "user" ? "user" : "bot");

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.innerHTML = role === "user" ? HUMAN_SVG : ROBOT_SVG;

    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text;

    if (role === "user") {         // user on the right
      m.appendChild(b);
      m.appendChild(avatar);
    } else {                       // bot on the left
      m.appendChild(avatar);
      m.appendChild(b);
    }

    msgs.appendChild(m);
    msgs.scrollTop = msgs.scrollHeight;
  }

  async function sendNow() {
    const val = inp.value.trim();
    if (!val) return;
    add("user", val);
    inp.value = "";
    btn.disabled = true;
    try {
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: val, history })
      });
      const data = await r.json();
      const reply = data.reply || "No response.";
      add("bot", reply); // << use 'bot', not 'assistant'
      history.push({ role: "user", content: val }, { role: "assistant", content: reply });
      history = history.slice(-8);
    } catch (e) {
      add("bot", "Request failed. Check server/logs.");
    } finally {
      btn.disabled = false;
    }
  }

  function clearChat() {
    msgs.innerHTML = "";
    history = [];
    add("bot", "Chat cleared. How can I help you next?");
  }

  // initial greeting via JS (so it has an avatar)
  add("bot", "Hi! I’m ready — what can I help you with?");

  // events
  btn.addEventListener("click", sendNow);
  inp.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendNow(); }
  });
  clearBtn?.addEventListener("click", clearChat);
});
</script>
</body>
</html>
